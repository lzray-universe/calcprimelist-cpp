name: Unified Build (Linux + Windows) with optional Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Git tag for release (留空只构建不发布)"
        required: false
        type: string
      prerelease:
        description: "标记为预发布 (prerelease)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  linux:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    name: Linux (${{ matrix.label }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # glibc 2.31: Debian 11 (bullseye)
          - label: glibc231-debian11-gcc
            container: debian:bullseye
            cc: gcc
            cxx: g++
            # 老基线 + 线程可能需要 atomic
            link_flags: "-static-libstdc++ -static-libgcc -pthread -latomic"
            artifact_suffix: glibc231
            zstd_from_source: "false"
            install: |
              apt-get update
              DEBIAN_FRONTEND=noninteractive apt-get install -y \
                build-essential cmake ninja-build pkg-config git ccache libzstd-dev
          # glibc 2.35: Ubuntu 22.04
          - label: glibc235-ubuntu2204-gcc
            container: ubuntu:22.04
            cc: gcc
            cxx: g++
            link_flags: "-static-libstdc++ -static-libgcc -pthread"
            artifact_suffix: glibc235
            zstd_from_source: "false"
            install: |
              apt-get update
              DEBIAN_FRONTEND=noninteractive apt-get install -y \
                build-essential cmake ninja-build pkg-config git ccache libzstd-dev
          # glibc 2.39: Ubuntu 24.04 —— 改为源码构建静态且 PIC 的 zstd
          - label: glibc239-ubuntu2404-gcc
            container: ubuntu:24.04
            cc: gcc
            cxx: g++
            link_flags: "-static-libstdc++ -static-libgcc -pthread"
            artifact_suffix: glibc239
            zstd_from_source: "true"   # <= 关键改动：避免把非 PIC 的系统 libzstd.a 链到 .so
            install: |
              apt-get update
              DEBIAN_FRONTEND=noninteractive apt-get install -y \
                build-essential cmake ninja-build pkg-config git ccache libzstd-dev
          # musl 全静态: Alpine 3.20
          - label: musl-static-alpine320-gcc
            container: alpine:3.20
            cc: gcc
            cxx: g++
            # musl 下真正全静态
            link_flags: "-static -pthread"
            artifact_suffix: musl_static
            zstd_from_source: "true"
            install: |
              set -eux
              apk add --no-cache build-base cmake ninja pkgconfig git ccache

    container: ${{ matrix.container }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install toolchain & base deps
        run: |
          set -eux
          ${{ matrix.install }}

      - name: Prepare zstd (always static for portability when building from source)
        env:
          ZSTD_FROM_SOURCE: ${{ matrix.zstd_from_source }}
        run: |
          set -eux
          : > /tmp/setenv

          make_zstd_static_from_source () {
            ZSTD_VER=v1.5.6
            git clone --depth=1 --branch "${ZSTD_VER}" https://github.com/facebook/zstd.git
            cmake -S zstd/build/cmake -B zstd_build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DZSTD_BUILD_SHARED=OFF \
              -DZSTD_BUILD_STATIC=ON \
              -DZSTD_LEGACY_SUPPORT=OFF \
              -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
              -DCMAKE_INSTALL_PREFIX="$GITHUB_WORKSPACE/deps/zstd"
            cmake --build zstd_build -j
            cmake --install zstd_build
            echo "ZSTD_INCLUDE_DIR=$GITHUB_WORKSPACE/deps/zstd/include" >> /tmp/setenv
            echo "ZSTD_LIBRARY=$GITHUB_WORKSPACE/deps/zstd/lib/libzstd.a" >> /tmp/setenv
          }

          if [ "${ZSTD_FROM_SOURCE}" = "true" ]; then
            # 源码编译静态且 PIC 的 libzstd.a（适配给 .so 使用）
            make_zstd_static_from_source
          else
            # glibc：优先使用系统的静态 libzstd.a，不存在则源码兜底
            if [ -f /etc/debian_version ] || [ -f /etc/lsb-release ]; then
              ZSTD_A="$(find /usr/lib /usr/local/lib -name 'libzstd.a' -print -quit || true)"
              if [ -n "${ZSTD_A}" ]; then
                echo "Using system static zstd: ${ZSTD_A}"
                if [ -f /usr/include/zstd.h ]; then
                  echo "ZSTD_INCLUDE_DIR=/usr/include" >> /tmp/setenv
                else
                  INC="$(dirname "$(dirname "${ZSTD_A}")")/include"
                  [ -f "${INC}/zstd.h" ] || INC="/usr/local/include"
                  echo "ZSTD_INCLUDE_DIR=${INC}" >> /tmp/setenv
                fi
                echo "ZSTD_LIBRARY=${ZSTD_A}" >> /tmp/setenv
              else
                echo "System static libzstd.a not found, building from source..."
                make_zstd_static_from_source
              fi
            else
              make_zstd_static_from_source
            fi
          fi

          cat /tmp/setenv >> "$GITHUB_ENV"

      - name: Configure (CMake + Ninja + ccache)
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
          LINK_FLAGS: ${{ matrix.link_flags }}
        run: |
          set -eux
          EXTRA_ZSTD_ARGS=""
          RPATH_ARG=""   # 我们静态链接 zstd，不需要 RPATH

          THREAD_FLAGS="-pthread"
          if [ -n "${ZSTD_INCLUDE_DIR:-}" ] && [ -n "${ZSTD_LIBRARY:-}" ]; then
            EXTRA_ZSTD_ARGS="-DZSTD_INCLUDE_DIR=${ZSTD_INCLUDE_DIR} -DZSTD_LIBRARY=${ZSTD_LIBRARY}"
          fi

          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_FLAGS="${THREAD_FLAGS}" \
            -DCMAKE_EXE_LINKER_FLAGS="${LINK_FLAGS}" \
            ${RPATH_ARG} \
            ${EXTRA_ZSTD_ARGS}

      - name: Build
        run: |
          set -eux
          cmake --build build -j

      - name: Smoke test
        run: |
          set -eux
          ./build/prime-sieve --help || true
          ctest --test-dir build --output-on-failure || true

      - name: Collect artifacts
        run: |
          set -eux
          mkdir -p out/${{ matrix.label }}
          [ -f build/prime-sieve ] && cp build/prime-sieve out/${{ matrix.label }}/prime-sieve-${{ matrix.artifact_suffix }}
          [ -f build/prime-sieve-static ] && cp build/prime-sieve-static out/${{ matrix.label }}/prime-sieve-static-${{ matrix.artifact_suffix }} || true
          ls build | grep -E '^libcalcprime(-cli)?\.' >/dev/null 2>&1 && cp build/libcalcprime* out/${{ matrix.label }}/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.artifact_suffix }}
          path: out/${{ matrix.label }}/
          if-no-files-found: warn

  windows:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    name: Windows (${{ matrix.triplet }} • ${{ matrix.config }})
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        config: [Release]
        triplet: [x64-windows-static, x64-windows]   # 静态&动态两份

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 用 vcpkg-action 安装依赖并开启缓存（会把 vcpkg 放在 ${{github.workspace}}\vcpkg）
      - name: Setup vcpkg and install deps
        id: vcpkg
        uses: johnwason/vcpkg-action@v7
        with:
          pkgs: zstd
          triplet: ${{ matrix.triplet }}
          token: ${{ github.token }}

      - name: Configure (CMake, MSVC)
        shell: pwsh
        run: >
          cmake ${{ steps.vcpkg.outputs.vcpkg-cmake-config }}
          -S . -B build\${{ matrix.triplet }}
          -G "Visual Studio 17 2022" -A x64
          -DCMAKE_BUILD_TYPE=${{ matrix.config }}
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded

      - name: Build
        shell: pwsh
        run: cmake --build build\${{ matrix.triplet }} --config ${{ matrix.config }} --parallel

      # 收集并打包
      - name: Collect artifacts
        shell: pwsh
        run: |
          $pkg = "package\${{ matrix.triplet }}\${{ matrix.config }}"
          New-Item -ItemType Directory -Force -Path $pkg | Out-Null

          # 可执行文件
          Get-ChildItem -Path "build\${{ matrix.triplet }}\${{ matrix.config }}" -Filter *.exe -Recurse | Copy-Item -Destination $pkg -Force

          # 动态三元组需要携带 vcpkg 安装的 DLL
          if ("${{ matrix.triplet }}" -eq "x64-windows") {
            $vcpkgBin = "${{ github.workspace }}\vcpkg\installed\${{ matrix.triplet }}\bin"
            if (Test-Path $vcpkgBin) { Copy-Item "$vcpkgBin\*.dll" $pkg -Force -ErrorAction SilentlyContinue }
          }

          if (Test-Path "README.md") { Copy-Item "README.md" $pkg }
          if (Test-Path "LICENSE")  { Copy-Item "LICENSE"  $pkg }

      - name: Zip package
        shell: pwsh
        run: |
          $zip = "build-${{ matrix.triplet }}-${{ matrix.config }}.zip"
          Compress-Archive -Path "package\${{ matrix.triplet }}\${{ matrix.config }}\*" -DestinationPath $zip -Force
          echo "ZIP_NAME=$zip" >> $env:GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}
          if-no-files-found: error

  # =========================
  # 新增：Linux ARM64
  # =========================
  linux_arm:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    name: Linux (ARM64)
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -eux
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential cmake ninja-build pkg-config git ccache libzstd-dev

      - name: Configure & Build (ARM64)
        run: |
          set -eux
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j

      - name: Collect artifacts
        run: |
          set -eux
          mkdir -p out/arm64
          [ -f build/prime-sieve ] && cp build/prime-sieve out/arm64/ || true
          [ -f build/prime-sieve-static ] && cp build/prime-sieve-static out/arm64/ || true
          ls build | grep -E '^libcalcprime(-cli)?\.' >/dev/null 2>&1 && cp build/libcalcprime* out/arm64/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: out/arm64/
          if-no-files-found: warn

  # =========================
  # 新增：Linux x86_64（禁用 AVX）
  # =========================
  linux_noavx:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    name: "Linux (no-AVX baseline)"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -eux
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential cmake ninja-build pkg-config git ccache libzstd-dev

      - name: Configure & Build (no-AVX)
        run: |
          set -eux
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_FLAGS="-march=x86-64 -mno-avx -mno-avx2 -mno-avx512f" \
            -DCMAKE_CXX_FLAGS="-march=x86-64 -mno-avx -mno-avx2 -mno-avx512f"
          cmake --build build -j

      - name: Collect artifacts
        run: |
          set -eux
          mkdir -p out/noavx
          [ -f build/prime-sieve ] && cp build/prime-sieve out/noavx/ || true
          [ -f build/prime-sieve-static ] && cp build/prime-sieve-static out/noavx/ || true
          ls build | grep -E '^libcalcprime(-cli)?\.' >/dev/null 2>&1 && cp build/libcalcprime* out/noavx/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-noavx
          path: out/noavx/
          if-no-files-found: warn

  # =========================
  # 新增：Windows ARM64（交叉编译）
  # =========================
  windows_arm:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    name: Windows (ARM64 • ${{ matrix.config }})
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        config: [Release]
        triplet: [arm64-windows-static, arm64-windows]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup vcpkg and install deps
        id: vcpkg
        uses: johnwason/vcpkg-action@v7
        with:
          pkgs: zstd
          triplet: ${{ matrix.triplet }}
          token: ${{ github.token }}

      - name: Configure (CMake, MSVC ARM64)
        shell: pwsh
        run: >
          cmake ${{ steps.vcpkg.outputs.vcpkg-cmake-config }}
          -S . -B build\${{ matrix.triplet }}
          -G "Visual Studio 17 2022" -A ARM64
          -DCMAKE_BUILD_TYPE=${{ matrix.config }}
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded

      - name: Build
        shell: pwsh
        run: cmake --build build\${{ matrix.triplet }} --config ${{ matrix.config }} --parallel

      - name: Collect artifacts
        shell: pwsh
        run: |
          $pkg = "package\${{ matrix.triplet }}\${{ matrix.config }}"
          New-Item -ItemType Directory -Force -Path $pkg | Out-Null
          Get-ChildItem -Path "build\${{ matrix.triplet }}\${{ matrix.config }}" -Filter *.exe -Recurse | Copy-Item -Destination $pkg -Force
          if ("${{ matrix.triplet }}" -eq "arm64-windows") {
            $vcpkgBin = "${{ github.workspace }}\vcpkg\installed\${{ matrix.triplet }}\bin"
            if (Test-Path $vcpkgBin) { Copy-Item "$vcpkgBin\*.dll" $pkg -Force -ErrorAction SilentlyContinue }
          }
          if (Test-Path "README.md") { Copy-Item "README.md" $pkg }
          if (Test-Path "LICENSE")  { Copy-Item "LICENSE"  $pkg }

      - name: Zip package
        shell: pwsh
        run: |
          $zip = "build-${{ matrix.triplet }}-${{ matrix.config }}.zip"
          Compress-Archive -Path "package\${{ matrix.triplet }}\${{ matrix.config }}\*" -DestinationPath $zip -Force
          echo "ZIP_NAME=$zip" >> $env:GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}
          if-no-files-found: error

  # =========================
  # 新增：Windows x64（no-AVX，带守门）
  # =========================
  windows_noavx:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    name: "Windows (x64 • no-AVX • ${{ matrix.config }})"
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        config: [Release]
        triplet: [x64-windows-static, x64-windows]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup vcpkg and install deps
        id: vcpkg
        uses: johnwason/vcpkg-action@v7
        with:
          pkgs: zstd
          triplet: ${{ matrix.triplet }}
          token: ${{ github.token }}

      - name: Configure (CMake, MSVC x64)
        shell: pwsh
        run: >
          cmake ${{ steps.vcpkg.outputs.vcpkg-cmake-config }}
          -S . -B build\${{ matrix.triplet }}
          -G "Visual Studio 17 2022" -A x64
          -DCMAKE_BUILD_TYPE=${{ matrix.config }}
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded

      - name: Build (capture log)
        shell: pwsh
        run: cmake --build build\${{ matrix.triplet }} --config ${{ matrix.config }} --parallel | Tee-Object -FilePath buildlog.txt

      - name: "Guard: fail if any AVX flags appear"
        shell: pwsh
        run: |
          if (Select-String -Pattern "/arch:AVX" -Path buildlog.txt) {
            Write-Host "Found AVX flags in MSVC build. Failing."; exit 1
          }

      - name: Collect artifacts
        shell: pwsh
        run: |
          $pkg = "package\${{ matrix.triplet }}\${{ matrix.config }}"
          New-Item -ItemType Directory -Force -Path $pkg | Out-Null
          Get-ChildItem -Path "build\${{ matrix.triplet }}\${{ matrix.config }}" -Filter *.exe -Recurse | Copy-Item -Destination $pkg -Force
          if ("${{ matrix.triplet }}" -eq "x64-windows") {
            $vcpkgBin = "${{ github.workspace }}\vcpkg\installed\${{ matrix.triplet }}\bin"
            if (Test-Path $vcpkgBin) { Copy-Item "$vcpkgBin\*.dll" $pkg -Force -ErrorAction SilentlyContinue }
          }
          if (Test-Path "README.md") { Copy-Item "README.md" $pkg }
          if (Test-Path "LICENSE")  { Copy-Item "LICENSE"  $pkg }

      - name: Zip package (no-AVX)
        shell: pwsh
        run: |
          $zip = "build-${{ matrix.triplet }}-${{ matrix.config }}-noavx.zip"
          Compress-Archive -Path "package\${{ matrix.triplet }}\${{ matrix.config }}\*" -DestinationPath $zip -Force
          echo "ZIP_NAME=$zip" >> $env:GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}
          if-no-files-found: error

  release:
    if: ${{ github.event.inputs.tag != '' && github.event_name == 'workflow_dispatch' }}
    name: Create Release
    needs:
      - linux
      - linux_arm
      - linux_noavx
      - windows
      - windows_arm
      - windows_noavx
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Pack artifacts for Release
        run: |
          set -eux
          mkdir -p release

          # 1) 拷贝 Windows 打包好的 zip
          find artifacts -type f -name '*.zip' -exec cp {} release/ \;

          # 2) 将 Linux 工件目录各自 zip（仅限名为 linux-* 的目录，避免重复打包 Windows）
          for d in artifacts/linux-*; do
            [ -d "$d" ] || continue
            name="$(basename "$d")"
            (cd "$d" && zip -r "../../release/${name}.zip" .)
          done

          ls -lh release

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.tag }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}              -DZSTD_BUILD_STATIC=ON \
              -DZSTD_LEGACY_SUPPORT=OFF \
              -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
              -DCMAKE_INSTALL_PREFIX="$GITHUB_WORKSPACE/deps/zstd"
            cmake --build zstd_build -j
            cmake --install zstd_build
            echo "ZSTD_INCLUDE_DIR=$GITHUB_WORKSPACE/deps/zstd/include" >> /tmp/setenv
            echo "ZSTD_LIBRARY=$GITHUB_WORKSPACE/deps/zstd/lib/libzstd.a" >> /tmp/setenv
          }

          if [ "${ZSTD_FROM_SOURCE}" = "true" ]; then
            # 源码编译静态且 PIC 的 libzstd.a（适配给 .so 使用）
            make_zstd_static_from_source
          else
            # glibc：优先使用系统的静态 libzstd.a，不存在则源码兜底
            if [ -f /etc/debian_version ] || [ -f /etc/lsb-release ]; then
              ZSTD_A="$(find /usr/lib /usr/local/lib -name 'libzstd.a' -print -quit || true)"
              if [ -n "${ZSTD_A}" ]; then
                echo "Using system static zstd: ${ZSTD_A}"
                if [ -f /usr/include/zstd.h ]; then
                  echo "ZSTD_INCLUDE_DIR=/usr/include" >> /tmp/setenv
                else
                  INC="$(dirname "$(dirname "${ZSTD_A}")")/include"
                  [ -f "${INC}/zstd.h" ] || INC="/usr/local/include"
                  echo "ZSTD_INCLUDE_DIR=${INC}" >> /tmp/setenv
                fi
                echo "ZSTD_LIBRARY=${ZSTD_A}" >> /tmp/setenv
              else
                echo "System static libzstd.a not found, building from source..."
                make_zstd_static_from_source
              fi
            else
              make_zstd_static_from_source
            fi
          fi

          cat /tmp/setenv >> "$GITHUB_ENV"

      - name: Configure (CMake + Ninja + ccache)
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
          LINK_FLAGS: ${{ matrix.link_flags }}
        run: |
          set -eux
          EXTRA_ZSTD_ARGS=""
          RPATH_ARG=""   # 我们静态链接 zstd，不需要 RPATH

          THREAD_FLAGS="-pthread"
          if [ -n "${ZSTD_INCLUDE_DIR:-}" ] && [ -n "${ZSTD_LIBRARY:-}" ]; then
            EXTRA_ZSTD_ARGS="-DZSTD_INCLUDE_DIR=${ZSTD_INCLUDE_DIR} -DZSTD_LIBRARY=${ZSTD_LIBRARY}"
          fi

          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_COMPILER_LAUNCHER=ccache \
            -DCMAKE_CXX_FLAGS="${THREAD_FLAGS}" \
            -DCMAKE_EXE_LINKER_FLAGS="${LINK_FLAGS}" \
            ${RPATH_ARG} \
            ${EXTRA_ZSTD_ARGS}

      - name: Build
        run: |
          set -eux
          cmake --build build -j

      - name: Smoke test
        run: |
          set -eux
          ./build/prime-sieve --help || true
          ctest --test-dir build --output-on-failure || true

      - name: Collect artifacts
        run: |
          set -eux
          mkdir -p out/${{ matrix.label }}
          [ -f build/prime-sieve ] && cp build/prime-sieve out/${{ matrix.label }}/prime-sieve-${{ matrix.artifact_suffix }}
          [ -f build/prime-sieve-static ] && cp build/prime-sieve-static out/${{ matrix.label }}/prime-sieve-static-${{ matrix.artifact_suffix }} || true
          ls build | grep -E '^libcalcprime(-cli)?\.' >/dev/null 2>&1 && cp build/libcalcprime* out/${{ matrix.label }}/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.artifact_suffix }}
          path: out/${{ matrix.label }}/
          if-no-files-found: warn

  windows:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    name: Windows (${{ matrix.triplet }} • ${{ matrix.config }})
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        config: [Release]
        triplet: [x64-windows-static, x64-windows]   # 静态&动态两份

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 用 vcpkg-action 安装依赖并开启缓存（会把 vcpkg 放在 ${{github.workspace}}\vcpkg）
      - name: Setup vcpkg and install deps
        id: vcpkg
        uses: johnwason/vcpkg-action@v7
        with:
          pkgs: zstd
          triplet: ${{ matrix.triplet }}
          token: ${{ github.token }}

      - name: Configure (CMake, MSVC)
        shell: pwsh
        run: >
          cmake ${{ steps.vcpkg.outputs.vcpkg-cmake-config }}
          -S . -B build\${{ matrix.triplet }}
          -G "Visual Studio 17 2022" -A x64
          -DCMAKE_BUILD_TYPE=${{ matrix.config }}
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded

      - name: Build
        shell: pwsh
        run: cmake --build build\${{ matrix.triplet }} --config ${{ matrix.config }} --parallel

      # 收集并打包
      - name: Collect artifacts
        shell: pwsh
        run: |
          $pkg = "package\${{ matrix.triplet }}\${{ matrix.config }}"
          New-Item -ItemType Directory -Force -Path $pkg | Out-Null

          # 可执行文件
          Get-ChildItem -Path "build\${{ matrix.triplet }}\${{ matrix.config }}" -Filter *.exe -Recurse | Copy-Item -Destination $pkg -Force

          # 动态三元组需要携带 vcpkg 安装的 DLL
          if ("${{ matrix.triplet }}" -eq "x64-windows") {
            $vcpkgBin = "${{ github.workspace }}\vcpkg\installed\${{ matrix.triplet }}\bin"
            if (Test-Path $vcpkgBin) { Copy-Item "$vcpkgBin\*.dll" $pkg -Force -ErrorAction SilentlyContinue }
          }

          if (Test-Path "README.md") { Copy-Item "README.md" $pkg }
          if (Test-Path "LICENSE")  { Copy-Item "LICENSE"  $pkg }

      - name: Zip package
        shell: pwsh
        run: |
          $zip = "build-${{ matrix.triplet }}-${{ matrix.config }}.zip"
          Compress-Archive -Path "package\${{ matrix.triplet }}\${{ matrix.config }}\*" -DestinationPath $zip -Force
          echo "ZIP_NAME=$zip" >> $env:GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}
          if-no-files-found: error

  # =========================
  # 新增：Linux ARM64
  # =========================
  linux_arm:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    name: Linux (ARM64)
    runs-on: ubuntu-24.04-arm

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -eux
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential cmake ninja-build pkg-config git ccache libzstd-dev

      - name: Configure & Build (ARM64)
        run: |
          set -eux
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release
          cmake --build build -j

      - name: Collect artifacts
        run: |
          set -eux
          mkdir -p out/arm64
          [ -f build/prime-sieve ] && cp build/prime-sieve out/arm64/ || true
          [ -f build/prime-sieve-static ] && cp build/prime-sieve-static out/arm64/ || true
          ls build | grep -E '^libcalcprime(-cli)?\.' >/dev/null 2>&1 && cp build/libcalcprime* out/arm64/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: out/arm64/
          if-no-files-found: warn

  # =========================
  # 新增：Linux x86_64（禁用 AVX）
  # =========================
  linux_noavx:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    name: "Linux (no-AVX baseline)"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          set -eux
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential cmake ninja-build pkg-config git ccache libzstd-dev

      - name: Configure & Build (no-AVX)
        run: |
          set -eux
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_C_FLAGS="-march=x86-64 -mno-avx -mno-avx2 -mno-avx512f" \
            -DCMAKE_CXX_FLAGS="-march=x86-64 -mno-avx -mno-avx2 -mno-avx512f"
          cmake --build build -j

      - name: Collect artifacts
        run: |
          set -eux
          mkdir -p out/noavx
          [ -f build/prime-sieve ] && cp build/prime-sieve out/noavx/ || true
          [ -f build/prime-sieve-static ] && cp build/prime-sieve-static out/noavx/ || true
          ls build | grep -E '^libcalcprime(-cli)?\.' >/dev/null 2>&1 && cp build/libcalcprime* out/noavx/ || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-noavx
          path: out/noavx/
          if-no-files-found: warn

  # =========================
  # 新增：Windows ARM64（交叉编译）
  # =========================
  windows_arm:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    name: Windows (ARM64 • ${{ matrix.config }})
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        config: [Release]
        triplet: [arm64-windows-static, arm64-windows]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup vcpkg and install deps
        id: vcpkg
        uses: johnwason/vcpkg-action@v7
        with:
          pkgs: zstd
          triplet: ${{ matrix.triplet }}
          token: ${{ github.token }}

      - name: Configure (CMake, MSVC ARM64)
        shell: pwsh
        run: >
          cmake ${{ steps.vcpkg.outputs.vcpkg-cmake-config }}
          -S . -B build\${{ matrix.triplet }}
          -G "Visual Studio 17 2022" -A ARM64
          -DCMAKE_BUILD_TYPE=${{ matrix.config }}
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded

      - name: Build
        shell: pwsh
        run: cmake --build build\${{ matrix.triplet }} --config ${{ matrix.config }} --parallel

      - name: Collect artifacts
        shell: pwsh
        run: |
          $pkg = "package\${{ matrix.triplet }}\${{ matrix.config }}"
          New-Item -ItemType Directory -Force -Path $pkg | Out-Null
          Get-ChildItem -Path "build\${{ matrix.triplet }}\${{ matrix.config }}" -Filter *.exe -Recurse | Copy-Item -Destination $pkg -Force
          if ("${{ matrix.triplet }}" -eq "arm64-windows") {
            $vcpkgBin = "${{ github.workspace }}\vcpkg\installed\${{ matrix.triplet }}\bin"
            if (Test-Path $vcpkgBin) { Copy-Item "$vcpkgBin\*.dll" $pkg -Force -ErrorAction SilentlyContinue }
          }
          if (Test-Path "README.md") { Copy-Item "README.md" $pkg }
          if (Test-Path "LICENSE")  { Copy-Item "LICENSE"  $pkg }

      - name: Zip package
        shell: pwsh
        run: |
          $zip = "build-${{ matrix.triplet }}-${{ matrix.config }}.zip"
          Compress-Archive -Path "package\${{ matrix.triplet }}\${{ matrix.config }}\*" -DestinationPath $zip -Force
          echo "ZIP_NAME=$zip" >> $env:GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}
          if-no-files-found: error

  # =========================
  # 新增：Windows x64（no-AVX，带守门）
  # =========================
  windows_noavx:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    name: "Windows (x64 • no-AVX • ${{ matrix.config }})"
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        config: [Release]
        triplet: [x64-windows-static, x64-windows]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup vcpkg and install deps
        id: vcpkg
        uses: johnwason/vcpkg-action@v7
        with:
          pkgs: zstd
          triplet: ${{ matrix.triplet }}
          token: ${{ github.token }}

      - name: Configure (CMake, MSVC x64)
        shell: pwsh
        run: >
          cmake ${{ steps.vcpkg.outputs.vcpkg-cmake-config }}
          -S . -B build\${{ matrix.triplet }}
          -G "Visual Studio 17 2022" -A x64
          -DCMAKE_BUILD_TYPE=${{ matrix.config }}
          -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreaded

      - name: Build (capture log)
        shell: pwsh
        run: cmake --build build\${{ matrix.triplet }} --config ${{ matrix.config }} --parallel | Tee-Object -FilePath buildlog.txt

      - name: "Guard: fail if any AVX flags appear"
        shell: pwsh
        run: |
          if (Select-String -Pattern "/arch:AVX" -Path buildlog.txt) {
            Write-Host "Found AVX flags in MSVC build. Failing."; exit 1
          }

      - name: Collect artifacts
        shell: pwsh
        run: |
          $pkg = "package\${{ matrix.triplet }}\${{ matrix.config }}"
          New-Item -ItemType Directory -Force -Path $pkg | Out-Null
          Get-ChildItem -Path "build\${{ matrix.triplet }}\${{ matrix.config }}" -Filter *.exe -Recurse | Copy-Item -Destination $pkg -Force
          if ("${{ matrix.triplet }}" -eq "x64-windows") {
            $vcpkgBin = "${{ github.workspace }}\vcpkg\installed\${{ matrix.triplet }}\bin"
            if (Test-Path $vcpkgBin) { Copy-Item "$vcpkgBin\*.dll" $pkg -Force -ErrorAction SilentlyContinue }
          }
          if (Test-Path "README.md") { Copy-Item "README.md" $pkg }
          if (Test-Path "LICENSE")  { Copy-Item "LICENSE"  $pkg }

      - name: Zip package (no-AVX)
        shell: pwsh
        run: |
          $zip = "build-${{ matrix.triplet }}-${{ matrix.config }}-noavx.zip"
          Compress-Archive -Path "package\${{ matrix.triplet }}\${{ matrix.config }}\*" -DestinationPath $zip -Force
          echo "ZIP_NAME=$zip" >> $env:GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ZIP_NAME }}
          path: ${{ env.ZIP_NAME }}
          if-no-files-found: error

  release:
    if: ${{ github.event.inputs.tag != '' && github.event_name == 'workflow_dispatch' }}
    name: Create Release
    needs: [linux, linux_arm, linux_noavx, windows, windows_arm, windows_noavx]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Pack artifacts for Release
        run: |
          set -eux
          mkdir -p release

          # 1) 先拷贝 Windows 打包好的 zip
          find artifacts -type f -name '*.zip' -exec cp {} release/ \;

          # 2) 将 Linux 工件目录各自 zip（仅限名为 linux-* 的目录，避免重复打包 Windows）
          for d in artifacts/linux-*; do
            [ -d "$d" ] || continue
            name="$(basename "$d")"
            (cd "$d" && zip -r "../../release/${name}.zip" .)
          done

          ls -lh release

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.tag }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}          mkdir -p release

          # 1) 先拷贝 Windows 打包好的 zip
          find artifacts -type f -name '*.zip' -exec cp {} release/ \;

          # 2) 将 Linux 工件目录各自 zip（仅限名为 linux-* 的目录，避免重复打包 Windows）
          for d in artifacts/linux-*; do
            [ -d "$d" ] || continue
            name="$(basename "$d")"
            (cd "$d" && zip -r "../../release/${name}.zip" .)
          done

          ls -lh release

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: ${{ github.event.inputs.tag }}
          prerelease: ${{ github.event.inputs.prerelease }}
          files: |
            release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}        run: |
          set -eux
          : > /tmp/setenv

          make_zstd_static_from_source () {
            ZSTD_VER=v1.5.6
            git clone --depth=1 --branch "${ZSTD_VER}" https://github.com/facebook/zstd.git
            cmake -S zstd/build/cmake -B zstd_build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DZSTD_BUILD_SHARED=OFF \
              -DZSTD_BUILD_STATIC=ON \
              -DZSTD_LEGACY_SUPPORT=OFF \
              -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
              -DCMAKE_INSTALL_PREFIX="$GITHUB_WORKSPACE/deps/zstd"
            cmake --build zstd_build -j
            cmake --install zstd_build
            echo "ZSTD_INCLUDE_DIR=$GITHUB_WORKSPACE/deps/zstd/include" | tee -a /tmp/setenv >> $GITHUB_ENV
            echo "ZSTD_LIBRARY=$GITHUB_WORKSPACE/deps/zstd/lib/libzstd.a" | tee -a /tmp/setenv >> $GITHUB_ENV
          }

          if [ "${ZSTD_FROM_SOURCE}" = "true" ]; then
            make_zstd_static_from_source
          else
            if [ -f /etc/debian_version ] || [ -f /etc/lsb-release ]; then
              ZSTD_A="$(find /usr/lib /usr/local/lib -name 'libzstd.a' -print -quit || true)"
              if [ -n "${ZSTD_A}" ]; then
                echo "Using system static zstd: ${ZSTD_A}"
                if [ -f /usr/include/zstd.h ]; then
                  echo "ZSTD_INCLUDE_DIR=/usr/include" | tee -a /tmp/setenv >> $GITHUB_ENV
                else
                  INC="$(dirname "$(dirname "${ZSTD_A}")")/include"
                  [ -f "${INC}/zstd.h" ] || INC="/usr/local/include"
                  echo "ZSTD_INCLUDE_DIR=${INC}" | tee -a /tmp/setenv >> $GITHUB_ENV
                fi
                echo "ZSTD_LIBRARY=${ZSTD_A}" | tee -a /tmp/setenv >> $GITHUB_ENV
              else
                echo "System static libzstd.a not found, building from source..."
                make_zstd_static_from_source
              fi
            else
              make_zstd_static_from_source
            fi
          fi

      - name: Configure & Build
        env:
          CC: ${{ matrix.cc }}
          CXX: ${{ matrix.cxx }}
        run: |
          set -eux
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_EXE_LINKER_FLAGS="${{ matrix.link_flags }}" \
            -DZSTD_INCLUDE_DIR="$ZSTD_INCLUDE_DIR" \
            -DZSTD_LIBRARY="$ZSTD_LIBRARY"
          cmake --build build -j

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: calcprime-linux-${{ matrix.artifact_suffix }}
          path: |
            build/prime-sieve*
            build/lib*.a
          if-no-files-found: warn

  # =========================
  # Linux x86_64 - NO AVX
  # =========================
  linux_noavx:
    needs: linux
    name: Linux (no-AVX baseline)
    runs-on: ubuntu-latest
    container: ubuntu:22.04
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          apt-get update
          DEBIAN_FRONTEND=noninteractive apt-get install -y \
            build-essential cmake ninja-build pkg-config git ccache libzstd-dev
      - name: Build (force no AVX)
        run: |
          set -eux
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_C_FLAGS="-march=x86-64 -mno-avx -mno-avx2 -mno-avx512f" \
            -DCMAKE_CXX_FLAGS="-march=x86-64 -mno-avx -mno-avx2 -mno-avx512f"
          cmake --build build -j
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: calcprime-linux-noavx
          path: build/prime-sieve*
          if-no-files-found: warn

  # =========================
  # Linux ARM64（公共仓库有官方 arm64 runner 标签）
  # =========================
  linux_arm64:
    if: ${{ github.event_name == 'workflow_dispatch' }}
    name: Linux ARM64 (${{ matrix.label }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-24.04-arm   # 公共仓库标签。私有仓库会失败。4
            label: glibc240-ubuntu2404-arm64
            container: ubuntu:24.04
            install: |
              apt-get update
              DEBIAN_FRONTEND=noninteractive apt-get install -y \
                build-essential cmake ninja-build pkg-config git ccache libzstd-dev
            artifact_suffix: linux_arm64
            zstd_from_source: "true"
          - os: ubuntu-22.04-arm   # 公共仓库标签。私有仓库会失败。5
            label: glibc235-ubuntu2204-arm64
            container: ubuntu:22.04
            install: |
              apt-get update
              DEBIAN_FRONTEND=noninteractive apt-get install -y \
                build-essential cmake ninja-build pkg-config git ccache libzstd-dev
            artifact_suffix: linux_arm64
            zstd_from_source: "false"
    container: ${{ matrix.container }}
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          set -eux
          ${{ matrix.install }}
      - name: zstd (static, PIC)
        env:
          ZSTD_FROM_SOURCE: ${{ matrix.zstd_from_source }}
        run: |
          set -eux
          : > /tmp/setenv
          make_zstd_static_from_source () {
            ZSTD_VER=v1.5.6
            git clone --depth=1 --branch "${ZSTD_VER}" https://github.com/facebook/zstd.git
            cmake -S zstd/build/cmake -B zstd_build -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DZSTD_BUILD_SHARED=OFF -DZSTD_BUILD_STATIC=ON \
              -DZSTD_LEGACY_SUPPORT=OFF -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
              -DCMAKE_INSTALL_PREFIX="$GITHUB_WORKSPACE/deps/zstd"
            cmake --build zstd_build -j
            cmake --install zstd_build
            echo "ZSTD_INCLUDE_DIR=$GITHUB_WORKSPACE/deps/zstd/include" | tee -a /tmp/setenv >> $GITHUB_ENV
            echo "ZSTD_LIBRARY=$GITHUB_WORKSPACE/deps/zstd/lib/libzstd.a" | tee -a /tmp/setenv >> $GITHUB_ENV
          }
          if [ "${ZSTD_FROM_SOURCE}" = "true" ]; then
            make_zstd_static_from_source
          else
            if [ -f /usr/include/zstd.h ]; then
              echo "ZSTD_INCLUDE_DIR=/usr/include" | tee -a /tmp/setenv >> $GITHUB_ENV
              echo "ZSTD_LIBRARY=/usr/lib/$(uname -m)-linux-gnu/libzstd.a" | tee -a /tmp/setenv >> $GITHUB_ENV
            else
              make_zstd_static_from_source
            fi
          fi
      - name: Configure & Build (arm64)
        run: |
          set -eux
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DZSTD_INCLUDE_DIR="$ZSTD_INCLUDE_DIR" -DZSTD_LIBRARY="$ZSTD_LIBRARY"
          cmake --build build -j
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: calcprime-${{ matrix.artifact_suffix }}-${{ matrix.label }}
          path: build/prime-sieve*
          if-no-files-found: warn

  # =========================
  # macOS（在 Apple Silicon 上同时产出 arm64 / x86_64）
  # =========================
  macos:
    name: macOS (${{ matrix.arch }})
    runs-on: macos-14   # Apple Silicon（推荐）。macOS 13 Intel 将退役。6
    strategy:
      fail-fast: false
      matrix:
        arch: [arm64, x86_64]
    steps:
      - uses: actions/checkout@v4
      - name: Install deps
        run: |
          set -eux
          brew update
          brew install cmake ninja pkg-config ccache
      - name: Build zstd (static, PIC) for ${{ matrix.arch }}
        run: |
          set -eux
          ZSTD_VER=v1.5.6
          git clone --depth=1 --branch "${ZSTD_VER}" https://github.com/facebook/zstd.git
          cmake -S zstd/build/cmake -B zstd_build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DZSTD_BUILD_SHARED=OFF -DZSTD_BUILD_STATIC=ON \
            -DZSTD_LEGACY_SUPPORT=OFF -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_INSTALL_PREFIX="$GITHUB_WORKSPACE/deps/zstd-${{ matrix.arch }}"
          cmake --build zstd_build -j
          cmake --install zstd_build
          echo "ZSTD_INCLUDE_DIR=$GITHUB_WORKSPACE/deps/zstd-${{ matrix.arch }}/include" >> $GITHUB_ENV
          echo "ZSTD_LIBRARY=$GITHUB_WORKSPACE/deps/zstd-${{ matrix.arch }}/lib/libzstd.a" >> $GITHUB_ENV
      - name: Configure & Build (${{ matrix.arch }})
        run: |
          set -eux
          cmake -S . -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${CMAKE_BUILD_TYPE} \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DZSTD_INCLUDE_DIR="$ZSTD_INCLUDE_DIR" -DZSTD_LIBRARY="$ZSTD_LIBRARY"
          cmake --build build -j
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: calcprime-macos-${{ matrix.arch }}
          path: build/prime-sieve*
          if-no-files-found: warn

  # =========================
  # Windows x64（No-AVX 守门）
  # =========================
  windows_x64_noavx:
    name: Windows x64 (no-AVX)
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build zstd (static) x64
        shell: pwsh
        run: |
          $ZSTD_VER="v1.5.6"
          git clone --depth=1 --branch $ZSTD_VER https://github.com/facebook/zstd.git
          cmake -S zstd/build/cmake -B zstd_build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} `
            -DZSTD_BUILD_SHARED=OFF -DZSTD_BUILD_STATIC=ON -DZSTD_LEGACY_SUPPORT=OFF `
            -DCMAKE_INSTALL_PREFIX="$env:GITHUB_WORKSPACE\deps\zstd-x64"
          cmake --build zstd_build --config Release -- /m
          cmake --install zstd_build --config Release
          "ZSTD_INCLUDE_DIR=$env:GITHUB_WORKSPACE\deps\zstd-x64\include" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ZSTD_LIBRARY=$env:GITHUB_WORKSPACE\deps\zstd-x64\lib\libzstd_static.lib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      - name: Configure & Build (x64)
        shell: pwsh
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} `
            -DZSTD_INCLUDE_DIR="$env:ZSTD_INCLUDE_DIR" -DZSTD_LIBRARY="$env:ZSTD_LIBRARY"
          cmake --build build --config Release -- /m | Tee-Object -FilePath buildlog.txt
      - name: "Guard: fail if any AVX flags appear"
        shell: pwsh
        run: |
          if (Select-String -Pattern "/arch:AVX" -Path buildlog.txt) {
            Write-Host "Found AVX flags in MSVC build. Failing."; exit 1
          }
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: calcprime-windows-x64-noavx
          path: build\*\Release\*

  # =========================
  # Windows ARM64（公共仓库 = 原生 runner；私有仓库 = 交叉构建）
  # =========================
  windows_arm64_native:
    name: Windows ARM64 (native runner)
    if: ${{ github.event.repository.private == false }}
    runs-on: windows-11-arm  # 公共仓库可用的官方标签。7
    steps:
      - uses: actions/checkout@v4
      - name: Build zstd (ARM64)
        shell: pwsh
        run: |
          $ZSTD_VER="v1.5.6"
          git clone --depth=1 --branch $ZSTD_VER https://github.com/facebook/zstd.git
          cmake -S zstd/build/cmake -B zstd_build -G "Visual Studio 17 2022" -A ARM64 `
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} `
            -DZSTD_BUILD_SHARED=OFF -DZSTD_BUILD_STATIC=ON -DZSTD_LEGACY_SUPPORT=OFF `
            -DCMAKE_INSTALL_PREFIX="$env:GITHUB_WORKSPACE\deps\zstd-arm64"
          cmake --build zstd_build --config Release -- /m
          cmake --install zstd_build --config Release
          "ZSTD_INCLUDE_DIR=$env:GITHUB_WORKSPACE\deps\zstd-arm64\include" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ZSTD_LIBRARY=$env:GITHUB_WORKSPACE\deps\zstd-arm64\lib\libzstd_static.lib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      - name: Configure & Build (ARM64)
        shell: pwsh
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A ARM64 `
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} `
            -DZSTD_INCLUDE_DIR="$env:ZSTD_INCLUDE_DIR" -DZSTD_LIBRARY="$env:ZSTD_LIBRARY"
          cmake --build build --config Release -- /m
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: calcprime-windows-arm64
          path: build\*\Release\*

  windows_arm64_cross:
    name: Windows ARM64 (cross on x64 runner)
    if: ${{ github.event.repository.private == true }}
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build zstd (ARM64)
        shell: pwsh
        run: |
          $ZSTD_VER="v1.5.6"
          git clone --depth=1 --branch $ZSTD_VER https://github.com/facebook/zstd.git
          cmake -S zstd/build/cmake -B zstd_build -G "Visual Studio 17 2022" -A ARM64 `
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} `
            -DZSTD_BUILD_SHARED=OFF -DZSTD_BUILD_STATIC=ON -DZSTD_LEGACY_SUPPORT=OFF `
            -DCMAKE_INSTALL_PREFIX="$env:GITHUB_WORKSPACE\deps\zstd-arm64"
          cmake --build zstd_build --config Release -- /m
          cmake --install zstd_build --config Release
          "ZSTD_INCLUDE_DIR=$env:GITHUB_WORKSPACE\deps\zstd-arm64\include" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          "ZSTD_LIBRARY=$env:GITHUB_WORKSPACE\deps\zstd-arm64\lib\libzstd_static.lib" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      - name: Configure & Build (ARM64)
        shell: pwsh
        run: |
          cmake -S . -B build -G "Visual Studio 17 2022" -A ARM64 `
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} `
            -DZSTD_INCLUDE_DIR="$env:ZSTD_INCLUDE_DIR" -DZSTD_LIBRARY="$env:ZSTD_LIBRARY"
          cmake --build build --config Release -- /m
      - name: Upload
        uses: actions/upload-artifact@v4
        with:
          name: calcprime-windows-arm64
          path: build\*\Release\*

  # =========================
  # 可选发布：只有传入 tag 才会执行
  # =========================
  release:
    if: ${{ inputs.tag != '' }}
    needs:
      - linux
      - linux_noavx
      - linux_arm64
      - macos
      - windows_x64_noavx
      - windows_arm64_native
      - windows_arm64_cross
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          prerelease: ${{ inputs.prerelease }}
          generate_release_notes: true
          files: |
            dist/**/*
